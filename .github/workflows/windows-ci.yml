name: Windows CI/CD

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Python Backend Tests (Windows)
  # ============================================================================
  python-tests:
    name: Python Tests (Windows)
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"
        shell: pwsh

      - name: Run Linting
        run: |
          pip install ruff
          ruff check cryptoai/ --select=E,F,W --ignore=E501
        shell: pwsh
        continue-on-error: true

      - name: Run Type Checking
        run: |
          pip install mypy
          mypy cryptoai/ --ignore-missing-imports --no-error-summary || true
        shell: pwsh
        continue-on-error: true

      - name: Run Unit Tests
        run: |
          python -m pytest tests/ -v --tb=short --timeout=120 -x
        shell: pwsh
        env:
          CRYPTOAI_TEST_MODE: 'true'
          CUDA_VISIBLE_DEVICES: ''

      - name: Run Import Tests
        run: |
          python -c "from cryptoai import __version__; print(f'CryptoAI version: {__version__}')"
          python -c "from cryptoai.encoders import UnifiedStateEncoder; print('Encoders: OK')"
          python -c "from cryptoai.decision_engine import PolicyNetwork; print('Decision Engine: OK')"
          python -c "from cryptoai.training import DDPConfig; print('Training: OK')"
          python -c "from cryptoai.backtesting import BacktestEngine; print('Backtesting: OK')"
          python -c "from cryptoai.risk_engine import RiskController; print('Risk Engine: OK')"
          python -c "from cryptoai.risk_engine import CVaRPositionSizer, create_cvar_position_sizer; print('CVaR Position Sizer: OK')"
          python -c "from cryptoai.data_universe.price_feed import create_price_feed, SyncPriceFeed; print('Price Feed: OK')"
          python -c "from cryptoai.execution.exchange_client import BinanceClient, OKXClient, BybitClient; print('Exchange Clients: OK')"
        shell: pwsh

      - name: Test CVaR Risk Engine
        run: |
          python -c "
          import torch
          from cryptoai.risk_engine import CVaRCalculator, DynamicDrawdownManager, InactionThreshold, ActionDecision

          # Test CVaR Calculator
          calc = CVaRCalculator()
          for i in range(100):
              calc.update(-0.01 + 0.02 * (i % 10) / 10)
          metrics = calc.calculate()
          print(f'CVaR 95: {metrics.cvar_95:.4f}')
          print(f'VaR 99: {metrics.var_99:.4f}')

          # Test Drawdown Manager
          dm = DynamicDrawdownManager()
          dd, action, reason = dm.update(100000)
          assert action == ActionDecision.TRADE, 'Should allow trading at start'
          dd, action, reason = dm.update(85000)  # 15% drawdown
          assert action == ActionDecision.FLATTEN or action == ActionDecision.REDUCE, 'Should reduce at high drawdown'
          print(f'Drawdown Manager: {action.value} - {reason}')

          # Test Inaction Threshold
          thresh = InactionThreshold()
          should_act, reason = thresh.should_act(confidence=0.8, uncertainty=0.1, expected_return=0.005)
          assert should_act, 'Should act with high confidence'
          should_act, reason = thresh.should_act(confidence=0.3, uncertainty=0.1, expected_return=0.005)
          assert not should_act, 'Should not act with low confidence'

          print('CVaR Risk Engine: PASSED')
          "
        shell: pwsh

      - name: Test Real Price Feed API
        run: |
          python -c "
          import asyncio
          from cryptoai.data_universe.price_feed import BinancePublicPriceFeed, PriceFeedConfig, PriceFeedProvider

          async def test_price_feed():
              config = PriceFeedConfig(
                  provider=PriceFeedProvider.BINANCE_PUBLIC,
                  symbols=['BTCUSDT'],
                  timeout_seconds=10.0
              )
              feed = BinancePublicPriceFeed(config)
              await feed.connect()
              try:
                  price = await feed.get_price('BTCUSDT')
                  if price and price.price > 0:
                      print(f'Real-time BTC price: USD {price.price:,.2f}')
                      print(f'24h Change: {price.change_24h:.2f}%')
                      print('Price feed integration: PASSED')
                  else:
                      print('Warning: Could not fetch real price (may be rate limited)')
              finally:
                  await feed.disconnect()

          asyncio.run(test_price_feed())
          "
        shell: pwsh
        timeout-minutes: 2
        continue-on-error: true

      - name: Run Backtest Validation
        run: |
          python -c "
          from cryptoai.backtesting import BacktestEngine
          from cryptoai.backtesting.engine import BacktestConfig
          from datetime import datetime, timedelta
          import numpy as np

          config = BacktestConfig(
              start_date=datetime.now() - timedelta(days=30),
              end_date=datetime.now(),
              initial_capital=100000
          )
          market_data = {'BTCUSDT': 50000 * np.exp(np.cumsum(np.random.normal(0, 0.001, 1000)))}
          engine = BacktestEngine(config, market_data)
          for i in range(100):
              engine.step({'BTCUSDT': market_data['BTCUSDT'][i]})
          print(f'Backtest completed: equity={engine.state.equity:.2f}')
          assert engine.state.equity > 0, 'Backtest failed - equity <= 0'
          print('Backtest validation: PASSED')
          "
        shell: pwsh

  # ============================================================================
  # Electron Desktop App Build (Windows)
  # ============================================================================
  electron-build:
    name: Build Electron App (Windows)
    runs-on: windows-latest
    needs: python-tests
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: electron/package-lock.json

      - name: Install Electron Dependencies
        working-directory: electron
        run: npm ci
        shell: pwsh

      - name: Build Windows Installer
        working-directory: electron
        run: npm run build:win
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List Build Artifacts
        working-directory: electron
        run: |
          Get-ChildItem -Path dist -Recurse | Format-Table Name, Length
        shell: pwsh

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: cryptoai-windows-installer
          path: |
            electron/dist/*.exe
            electron/dist/*.msi
          if-no-files-found: warn
          retention-days: 14

      - name: Upload Portable Build
        uses: actions/upload-artifact@v4
        with:
          name: cryptoai-windows-portable
          path: electron/dist/*portable*.exe
          if-no-files-found: warn
          retention-days: 14

  # ============================================================================
  # Integration Tests (Windows)
  # ============================================================================
  integration-tests:
    name: Integration Tests (Windows)
    runs-on: windows-latest
    needs: python-tests
    timeout-minutes: 20

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"
        shell: pwsh

      - name: Test CLI Entry Point
        run: |
          python -m cryptoai.cli --help
        shell: pwsh

      - name: Test Shadow Mode Startup
        run: |
          $process = Start-Process -FilePath "python" -ArgumentList "-m", "cryptoai.main", "--mode", "shadow", "--config", "configs/default.yaml" -PassThru -NoNewWindow
          Start-Sleep -Seconds 5
          if (!$process.HasExited) {
            Stop-Process -Id $process.Id -Force
            Write-Host "Shadow mode started and stopped successfully"
          } else {
            Write-Host "Process exited with code: $($process.ExitCode)"
          }
        shell: pwsh
        timeout-minutes: 2
        continue-on-error: true

      - name: Test Data Pipeline
        run: |
          python -c "
          from cryptoai.training.data_loader import create_synthetic_data
          import tempfile
          import os
          with tempfile.TemporaryDirectory() as tmpdir:
              path = os.path.join(tmpdir, 'test_data.h5')
              create_synthetic_data(path, n_samples=100, sequence_length=50)
              print(f'Created synthetic data: {path}')
              assert os.path.exists(path), 'Synthetic data file not created'
              print('Data pipeline: PASSED')
          "
        shell: pwsh

  # ============================================================================
  # Security Scan
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Security Tools
        run: |
          pip install bandit safety
        shell: pwsh

      - name: Run Bandit Security Scan
        run: |
          bandit -r cryptoai/ -ll -ii --skip B101,B311 || true
        shell: pwsh
        continue-on-error: true

      - name: Check Dependencies for Vulnerabilities
        run: |
          pip install -e .
          safety check --full-report || true
        shell: pwsh
        continue-on-error: true

  # ============================================================================
  # Release (on tag)
  # ============================================================================
  release:
    name: Create Release
    runs-on: windows-latest
    needs: [python-tests, electron-build, integration-tests]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: cryptoai-windows-installer
          path: ./release

      - name: Download Portable Build
        uses: actions/download-artifact@v4
        with:
          name: cryptoai-windows-portable
          path: ./release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./release/*
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
